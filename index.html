<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignment MLE - Custom Paraphrase Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Preserves formatting while wrapping text */
        .formatted-output { white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', Courier, monospace; }
        .busy-disabled { opacity: 0.6; pointer-events: none; cursor: not-allowed; }
    </style>
</head>
<body class="p-6">

<div class="max-w-7xl mx-auto space-y-6">
    
    <header class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
        <h1 class="text-2xl font-bold text-gray-800">Custom Paraphrase Generator (CPG)</h1>
        <p class="text-gray-500 text-sm mt-1">Non-blocking Interface • Web Worker Integration • Structure Preservation</p>
        <div id="status" class="mt-4 text-sm px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full inline-flex items-center gap-2">
            <span class="spinner"></span>
            <span id="statusText">Initializing Worker...</span>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <div class="space-y-4">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 h-full">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-semibold text-gray-700">Input Text</h2>
                    <div class="space-x-2" id="sampleButtons">
                        <button onclick="loadLetterSample()" class="text-blue-600 text-xs hover:underline bg-blue-50 px-2 py-1 rounded">Load Letter</button>
                        <button onclick="loadPDFSample()" class="text-blue-600 text-xs hover:underline bg-blue-50 px-2 py-1 rounded">Load PDF Text</button>
                    </div>
                </div>
                <textarea id="inputText" class="w-full h-96 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none font-mono text-sm" placeholder="Paste your text here..."></textarea>
                
                <div class="flex justify-between mt-2 text-sm text-gray-500">
                    <span id="inputWordCount">Words: 0</span>
                    <span id="inputStatus" class="text-gray-400">Ready</span>
                </div>
                
                <button id="generateBtn" onclick="startGeneration()" disabled class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2">
                    Generate Paraphrase
                </button>
                
                <div id="progressContainer" class="hidden mt-4 space-y-2">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span id="timerLabel">Time: 0.0s</span>
                        <span id="progressLabel">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="progressFill" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-4">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 relative">
                <div class="absolute top-0 left-0 bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-br-lg rounded-tl-lg">CPG MODEL</div>
                <h2 class="font-semibold text-gray-700 mb-4 pl-20">Generated Output</h2>
                
                <div id="outputContainer" class="h-64 overflow-y-auto p-4 bg-gray-50 rounded-lg border border-gray-200 text-gray-700 text-sm leading-relaxed formatted-output">
                    <span class="text-gray-400 italic font-sans">Output will appear here retaining your format...</span>
                </div>

                <div class="flex justify-between mt-2 text-sm text-gray-500">
                    <span id="outputWordCount">Words: 0</span>
                    <span id="lengthRatio" class="font-mono bg-gray-200 px-2 rounded">Len Ratio: 0%</span>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 relative">
                <div class="absolute top-0 left-0 bg-green-600 text-white text-xs font-bold px-3 py-1 rounded-br-lg rounded-tl-lg">BENCHMARK LLM</div>
                <div class="flex justify-between items-center mb-2 pl-24">
                    <h2 class="font-semibold text-gray-700">Comparison</h2>
                    <span class="text-xs text-gray-400">Paste ChatGPT/Gemini output here</span>
                </div>
                <textarea id="llmInputText" oninput="updateMetrics()" class="w-full h-32 p-3 border border-gray-300 rounded-lg text-sm font-mono" placeholder="Paste external LLM output here to compare metrics..."></textarea>
            </div>
        </div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
        <h2 class="font-bold text-gray-800 mb-4 border-b pb-2">Evaluation Metrics</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="metric-card bg-blue-50 p-4 rounded-lg border border-blue-100">
                <div class="text-blue-800 text-sm font-semibold mb-1">System Latency</div>
                <div id="metricLatency" class="text-2xl font-bold text-blue-900">-</div>
                <div class="text-xs text-blue-600 mt-1">Processing time</div>
            </div>
            <div class="metric-card bg-purple-50 p-4 rounded-lg border border-purple-100">
                <div class="text-purple-800 text-sm font-semibold mb-1">Length Compliance</div>
                <div id="metricCompliance" class="text-2xl font-bold text-purple-900">-</div>
                <div class="text-xs text-purple-600 mt-1">Target: > 80%</div>
            </div>
            <div class="metric-card bg-green-50 p-4 rounded-lg border border-green-100">
                <div class="text-green-800 text-sm font-semibold mb-1">CPG Overlap Score</div>
                <div id="metricCpgScore" class="text-2xl font-bold text-green-900">-</div>
                <div class="text-xs text-green-600 mt-1">Jaccard Similarity</div>
            </div>
             <div class="metric-card bg-gray-50 p-4 rounded-lg border border-gray-200">
                <div class="text-gray-800 text-sm font-semibold mb-1">LLM Overlap Score</div>
                <div id="metricLlmScore" class="text-2xl font-bold text-gray-900">-</div>
                <div class="text-xs text-gray-600 mt-1">Benchmark</div>
            </div>
        </div>
    </div>
</div>

<script id="worker-code" type="javascript/worker">
    // This code runs in the background thread
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.16.0';

    env.allowLocalModels = false;
    env.useBrowserCache = true;

    let generator = null;

    self.onmessage = async (e) => {
        const { type, data } = e.data;

        if (type === 'init') {
            try {
                // Load Model
                self.postMessage({ type: 'status', status: 'loading' });
                generator = await pipeline('text2text-generation', 'Xenova/LaMini-Flan-T5-248M');
                self.postMessage({ type: 'status', status: 'ready' });
            } catch (err) {
                self.postMessage({ type: 'error', message: err.message });
            }
        }

        if (type === 'generate') {
            if (!generator) return;

            const rawText = data.text;
            const lines = rawText.split('\n');
            let processedLines = [];
            
            // Iterate lines
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmed = line.trim();
                const lineWordCount = trimmed.length === 0 ? 0 : trimmed.split(/\s+/).length;

                // 1. Process Logic
                let resultLine = line;

                // Simple heuristic: If empty or short (<15 words), keep original (Header/Date/Salutation)
                if (trimmed.length > 0 && lineWordCount >= 15) {
                    try {
                        const prompt = `Paraphrase this paragraph formally and in detail: ${trimmed}`;
                        const output = await generator(prompt, {
                            max_new_tokens: 512,
                            min_length: Math.floor(lineWordCount * 0.9),
                            temperature: 0.6,
                            repetition_penalty: 1.2,
                            do_sample: true
                        });
                        resultLine = output[0].generated_text;
                    } catch (e) {
                        resultLine = line; // Fallback
                    }
                }

                processedLines.push(resultLine);

                // 2. Send Partial Update back to Main Thread
                self.postMessage({
                    type: 'progress',
                    progress: Math.round(((i + 1) / lines.length) * 100),
                    currentText: processedLines.join('\n')
                });
            }

            // 3. Complete
            self.postMessage({
                type: 'complete',
                text: processedLines.join('\n')
            });
        }
    };
</script>

<script type="module">
    // UI Elements
    const statusDiv = document.getElementById('status');
    const statusText = document.getElementById('statusText');
    const generateBtn = document.getElementById('generateBtn');
    const inputArea = document.getElementById('inputText');
    const outputArea = document.getElementById('outputContainer');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressLabel = document.getElementById('progressLabel');
    const timerLabel = document.getElementById('timerLabel');
    const sampleButtons = document.getElementById('sampleButtons');

    let worker = null;
    let timerInterval = null;
    let startTime = 0;
    let isModelReady = false;

    // 1. Setup Worker
    function initWorker() {
        const blob = new Blob([document.getElementById('worker-code').textContent], { type: 'application/javascript' });
        worker = new Worker(URL.createObjectURL(blob), { type: 'module' });

        worker.onmessage = function(e) {
            const { type, status, message, progress, currentText, text } = e.data;

            if (type === 'status') {
                if (status === 'loading') {
                    statusText.innerText = "Downloading Model (~250MB)...";
                } else if (status === 'ready') {
                    statusDiv.className = "mt-4 text-sm px-3 py-1 bg-green-100 text-green-800 rounded-full inline-flex items-center gap-2";
                    statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> <span>Model Ready</span>';
                    isModelReady = true;
                    validateInput();
                }
            } else if (type === 'error') {
                statusDiv.className = "mt-4 text-sm px-3 py-1 bg-red-100 text-red-800 rounded-full inline-flex items-center gap-2";
                statusText.innerText = "Error: " + message;
            } else if (type === 'progress') {
                // Update Progress Bar
                progressFill.style.width = `${progress}%`;
                progressLabel.innerText = `${progress}%`;
                // Live Text Update
                outputArea.innerText = currentText;
            } else if (type === 'complete') {
                finishGeneration(text);
            }
        };

        // Initialize Model inside Worker
        worker.postMessage({ type: 'init' });
    }

    // 2. Generation Control
    window.startGeneration = function() {
        if (!isModelReady) return;
        
        // Lock UI
        inputArea.classList.add('busy-disabled');
        sampleButtons.classList.add('busy-disabled');
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<span class="spinner"></span> Processing...';
        progressContainer.classList.remove('hidden');
        outputArea.innerText = "";
        
        startTime = performance.now();
        
        // Start Timer (This will now remain smooth because work is in background)
        timerInterval = setInterval(() => {
            const t = ((performance.now() - startTime) / 1000).toFixed(1);
            timerLabel.innerText = `Time: ${t}s`;
        }, 100);

        // Send Job to Worker
        worker.postMessage({ 
            type: 'generate', 
            data: { text: inputArea.value } 
        });
    };

    function finishGeneration(finalText) {
        clearInterval(timerInterval);
        const endTime = performance.now();
        const totalTime = ((endTime - startTime) / 1000).toFixed(2);
        
        // Unlock UI
        inputArea.classList.remove('busy-disabled');
        sampleButtons.classList.remove('busy-disabled');
        generateBtn.disabled = false;
        generateBtn.innerText = "Generate Paraphrase";
        
        // Finalize
        outputArea.innerText = finalText;
        document.getElementById('metricLatency').innerText = `${totalTime}s`;
        updateMetrics(finalText);
    }

    // 3. Validation & Metrics (Same as before)
    inputArea.addEventListener('input', validateInput);

    function validateInput() {
        const text = inputArea.value.trim();
        const words = text.length === 0 ? 0 : text.split(/\s+/).length;
        document.getElementById('inputWordCount').innerText = `Words: ${words}`;
        generateBtn.disabled = !isModelReady || words === 0;
    }

    window.updateMetrics = function(cpgTextOverride = null) {
        const sourceText = inputArea.value.trim();
        const cpgText = cpgTextOverride || outputArea.innerText;
        const llmText = document.getElementById('llmInputText').value.trim();

        if (cpgText.includes("Output will appear")) return;

        const sourceWords = sourceText.split(/\s+/).length;
        const cpgWords = cpgText.split(/\s+/).length;
        
        document.getElementById('outputWordCount').innerText = `Words: ${cpgWords}`;
        const ratio = sourceWords > 0 ? ((cpgWords / sourceWords) * 100).toFixed(1) : 0;
        document.getElementById('lengthRatio').innerText = `Len Ratio: ${ratio}%`;
        
        const compEl = document.getElementById('metricCompliance');
        compEl.innerText = `${ratio}%`;
        compEl.className = ratio >= 80 ? "text-2xl font-bold text-green-600" : "text-2xl font-bold text-red-600";

        if(cpgWords > 0) document.getElementById('metricCpgScore').innerText = calculateJaccard(sourceText, cpgText).toFixed(2);
        if(llmText.length > 0) document.getElementById('metricLlmScore').innerText = calculateJaccard(sourceText, llmText).toFixed(2);
    }

    function calculateJaccard(str1, str2) {
        const set1 = new Set(str1.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/));
        const set2 = new Set(str2.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/));
        const intersection = new Set([...set1].filter(x => set2.has(x)));
        const union = new Set([...set1, ...set2]);
        return union.size === 0 ? 0 : intersection.size / union.size;
    }

    window.loadLetterSample = function() {
        inputArea.value = `Rahul Verma\n23 Green Gardens Road\nBengaluru, Karnataka 560076\nrahul.verma@example.com\n\n+91 98765 43210\n12 December 2025\n\nAnita Sharma\nHiring Manager\nABC Innovations Pvt. Ltd.\nKoramangala, Bengaluru, 560095\n\nDear Ms. Sharma,\n\nI am writing to express my interest in the Associate Product Designer position at ABC Innovations Pvt. Ltd. With a strong foundation in design thinking, user experience principles, and product development, I am confident in my ability to contribute meaningfully to your team.\n\nIn my academic projects and internships, I have developed practical skills in user research, prototyping, and usability testing. I have worked on multiple end-to-end design assignments where I collaborated with cross-functional teams to identify user needs, develop creative solutions, and translate them into functional and visually appealing product designs. My ability to synthesize complex information and transform it into clear, user-centered concepts has been a key strength throughout my experience.\n\nI am particularly drawn to ABC Innovations because of your reputation for combining innovation with human-centered design. The opportunity to learn from your experienced team and to contribute to impactful projects truly excites me. I believe my passion for thoughtful product development and my commitment to continuous learning align well with your organization’s goals.\n\nThank you for considering my application. I welcome the opportunity to discuss how my background and skills can support your team. I look forward to the possibility of speaking with you soon.\n\nSincerely,\nRahul Verma`;
        validateInput();
    }
    
    window.loadPDFSample = function() {
        inputArea.value = `A cover letter is a formal document that accompanies your resume when you apply for a job. It serves as an introduction and provides additional context for your application. Here's a breakdown of its various aspects: Purpose The primary purpose of a cover letter is to introduce yourself to the hiring manager and to provide context for your resume. It allows you to elaborate on your qualifications, skills, and experiences in a way that your resume may not fully capture. It's also an opportunity to express your enthusiasm for the role and the company, and to explain why you would be a good fit. Content A typical cover letter includes the following sections: 1. Header: Includes your contact information, the date, and the employer's contact information. 2. Salutation: A greeting to the hiring manager, preferably personalized with their name. 3. Introduction: Briefly introduces who you are and the position you're applying for. 4. Body: This is the core of your cover letter where you discuss your qualifications, experiences, and skills that make you suitable for the job. You can also mention how you can contribute to the company. 5. Conclusion: Summarizes your points and reiterates your enthusiasm for the role. You can also include a call to action, like asking for an interview. 6. Signature: A polite closing ("Sincerely," "Best regards," etc.) followed by your name. Significance in the Job Application Process The cover letter is often the first document that a hiring manager will read, so it sets the tone for your entire application. It provides you with a chance to stand out among other applicants and to make a strong first impression. Some employers specifically require a cover letter, and failing to include one could result in your application being disregarded. In summary, a cover letter is an essential component of a job application that serves to introduce you, elaborate on your qualifications, and make a compelling case for why you should be considered for the position.`;
        validateInput();
    }

    // Start Worker on Load
    initWorker();
</script>

</body>
</html>